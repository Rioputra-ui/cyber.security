<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TensorFlow Complete Detection System - Demo</title>

<style>
  :root{
    --bg1:#213E8C;
    --bg2:#6C3BCE;
    --card:#ffffff;
    --muted:#9aa6c3;
    --accent:#2ee26e;
  }
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, system-ui, -apple-system;}
  body{
    background: linear-gradient(180deg,var(--bg1), var(--bg2));
    padding: 28px;
    box-sizing: border-box;
  }

  .app{
    max-width:1200px;
    margin:0 auto;
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:22px;
  }

  header{
    grid-column:1/-1;
    color:#fff;
    margin-bottom:6px;
  }

  header h1{
    margin:0;
    font-size:30px;
    text-shadow:0 2px 6px rgba(0,0,0,0.3);
  }

  header p{
    margin:6px 0 0;
    color:#dde7ffb0;
  }

  .panel{
    background:var(--card);
    border-radius:14px;
    padding:18px;
    box-shadow: 0 8px 30px rgba(3,12,36,0.25);
  }

  .video-wrap{
    position:relative;
    width:100%;
    height:600px;
    border-radius:10px;
    overflow:hidden;
    background:#111;
  }

  video#cam{
    width:100%;
    height:100%;
    object-fit:cover;
    transform: scaleX(-1);
  }

  canvas#overlay{
    position:absolute;
    left:0; top:0;
    width:100%; height:100%;
    pointer-events:none;
  }

  .badge{
    position:absolute;
    left:12px; top:12px;
    background: rgba(0,0,0,0.6);
    color:#fff;
    padding:10px 12px;
    border-radius:8px;
    font-size:13px;
    line-height:1.2;
  }

  .fps{
    position:absolute;
    right:12px; top:12px;
    background:#0f0f0f;
    color:#6fff6f;
    padding:8px 10px;
    border-radius:8px;
    font-weight:700;
  }

  .sidebar{
    display:flex;
    flex-direction:column;
    gap:18px;
  }

  .card{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    box-shadow: 0 6px 20px rgba(3,12,36,0.12);
  }

  .card h3{margin:0 0 10px;color:#24324a;}

  .info-color{
    display:flex;
    gap:12px;
    align-items:center;
  }

  .swatch{
    width:86px;height:86px;border-radius:10px;
    box-shadow:0 8px 20px rgba(3,12,36,0.08);
    border:1px solid rgba(0,0,0,0.06);
  }

  .meta small{
    color:var(--muted);
    display:block;
  }

  .big-number{
    display:flex;
    justify-content:center;
    align-items:center;
    font-weight:700;
    font-size:34px;
    color:#fff;
    background:linear-gradient(180deg,#6e8cff,#7b5bff);
    padding:20px;
    border-radius:12px;
  }

  .controls{
    display:flex;
    gap:8px;
    margin-top:12px;
    justify-content:center;
  }

  button{
    padding:10px 16px;
    border-radius:999px;
    border:none;
    font-weight:600;
    cursor:pointer;
  }

  .btn-start{
    background:linear-gradient(90deg,#5a91ff,#7b5bff); color:white
  }

  .btn-stop{
    background:linear-gradient(90deg,#ff7d8a,#ffb0d0); color:white
  }

  .obj-list{
    min-height:120px;
    padding:8px;
    border-radius:10px;
    background:#fafcff;
    border:1px solid rgba(0,0,0,0.03)
  }

  .obj-item{
    padding:6px 8px;
    border-radius:8px;
    margin-bottom:6px;
    background:linear-gradient(180deg,#0bff0070,#0bff00);
    color:#003800;
    font-weight:700;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  footer{
    grid-column:1/-1;
    margin-top:12px;
    color:#eaf0ff;
    font-size:13px;
    text-align:right;
  }

  @media(max-width:1000px){
    .app{grid-template-columns:1fr}
    .video-wrap{height:480px}
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>TensorFlow Complete Detection System</h1>
      <p>Deteksi Objek, Warna & Jarak Secara Realtime (demo)</p>
    </header>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:700;color:#24324a">Mode: <span id="modeLabel">Semua Aktif</span></div>
        <div style="color:#6b7280;font-size:13px">Objek terdeteksi: <strong id="objCount">0</strong></div>
      </div>

      <div class="video-wrap" id="videoWrap">
        <video id="cam" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>

        <div class="badge" id="badgeTop">
          <div style="font-size:13px">üîç Mode: Semua Aktif</div>
          <div style="margin-top:6px;font-size:13px">üéØ Warna: <span id="detectedName">Tidak Dikenal</span></div>
          <div style="margin-top:6px;font-size:13px">üìè Jarak: <span id="detectedDist">-</span></div>
        </div>

        <div class="fps" id="fps">FPS: 0</div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:14px;justify-content:center">
        <button class="btn-start" id="startBtn">Mulai Kamera</button>
        <button class="btn-stop" id="stopBtn">Stop Kamera</button>
      </div>
    </div>

    <div class="sidebar">
      <div class="card">
        <h3>Deteksi Objek</h3>
        <div class="obj-list" id="objectList"></div>
      </div>

      <div class="card">
        <h3>Deteksi Warna</h3>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="swatch" id="swatch"></div>
          <div class="meta">
            <strong id="colorName">Tidak Dikenal</strong>
            <small id="rgbText">RGB: -</small>
            <small id="hexText">HEX: -</small>
            <small id="hslText">HSL: -</small>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Deteksi Jarak</h3>
        <div class="big-number" id="distBox">-</div>
      </div>
    </div>

    <footer>Demo menggunakan TensorFlow.js (COCO-SSD). Tidak 100% akurat untuk jarak ‚Äî ini estimasi.</footer>
  </div>

  <!-- TFJS & COCO SSD -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>

  <script>
  const video = document.getElementById('cam');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const fpsEl = document.getElementById('fps');
  const objCountEl = document.getElementById('objCount');
  const objectList = document.getElementById('objectList');
  const swatch = document.getElementById('swatch');
  const colorNameEl = document.getElementById('colorName');
  const rgbText = document.getElementById('rgbText');
  const hexText = document.getElementById('hexText');
  const hslText = document.getElementById('hslText');
  const detectedNameEl = document.getElementById('detectedName');
  const detectedDistEl = document.getElementById('detectedDist');
  const distBox = document.getElementById('distBox');

  let model = null;
  let stream = null;
  let running = false;

  let lastTime = performance.now();
  let frames = 0;
  let fps = 0;

  const DIST_CONST = 400;

  async function startAll(){
    if(running) return;

    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{width:1280,height:720},
        audio:false
      });

      video.srcObject = stream;
      await video.play();

      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;

      running = true;

      if(!model){
        model = await cocoSsd.load();
      }

      detectLoop();

    }catch(e){
      alert("Gagal membuka kamera: " + e.message);
    }
  }

  function stopAll(){
    running = false;
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    ctx.clearRect(0,0,overlay.width,overlay.height);
  }

  async function detectLoop(){
    if(!running) return;

    const predictions = await model.detect(video, 20);

    frames++;
    const now = performance.now();
    if(now - lastTime >= 1000){
      fps = frames;
      frames = 0;
      lastTime = now;
      fpsEl.textContent = "FPS: " + fps;
    }

    ctx.clearRect(0,0,overlay.width,overlay.height);

    let objs = [];

    predictions.forEach(pred => {
      const [x,y,w,h] = pred.bbox;
      const drawX = overlay.width - (x + w);

      ctx.lineWidth = 4;
      ctx.strokeStyle = "#00ff33";
      ctx.fillStyle = "#00ff33";

      ctx.beginPath();
      roundRect(ctx, drawX, y, w, h, 6);
      ctx.stroke();

      ctx.font = "18px Poppins, Inter, sans-serif";
      const label = `${pred.class} ${Math.round(pred.score*100)}%`;

      const txtW = ctx.measureText(label).width + 12;
      ctx.fillRect(drawX, y - 28, txtW, 26);

      ctx.fillStyle = "#002700";
      ctx.fillText(label, drawX + 6, y - 6);

      objs.push({
        cls: pred.class,
        score: pred.score,
        bbox: pred.bbox
      });
    });

    objectList.innerHTML = "";
    objs.slice(0,6).forEach(o=>{
      const div = document.createElement("div");
      div.className = "obj-item";
      div.innerHTML = `
        <div>${o.cls}</div>
        <div>${Math.round(o.score*100)}%</div>
      `;
      objectList.appendChild(div);
    });

    objCountEl.textContent = objs.length;

    // Color
    const c = sampleCenterPixel();
    updateColorUI(c);

    // Distance
    if(objs.length>0){
      let maxH = 0, chosen=null;
      objs.forEach(o=>{
        if(o.bbox[3] > maxH){
          maxH = o.bbox[3];
          chosen = o;
        }
      });

      if(chosen){
        const est = estimateDistance(maxH);
        distBox.textContent = est.toFixed(2)+" m";
        detectedDistEl.textContent = est.toFixed(2)+" m";
      }
    }

    drawCrosshair();
    requestAnimationFrame(detectLoop);
  }

  function roundRect(ctx,x,y,w,h,r){
    ctx.moveTo(x+r,y);
    ctx.lineTo(x+w-r,y);
    ctx.quadraticCurveTo(x+w,y,x+w,y+r);
    ctx.lineTo(x+w,y+h-r);
    ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    ctx.lineTo(x+r,y+h);
    ctx.quadraticCurveTo(x,y+h,x,y+h-r);
    ctx.lineTo(x,y+r);
    ctx.quadraticCurveTo(x,y,x+r,y);
  }

  function drawCrosshair(){
    const cx = overlay.width/2;
    const cy = overlay.height/2;

    ctx.strokeStyle = "#00ff7f";
    ctx.lineWidth = 2;

    ctx.beginPath();
    ctx.arc(cx, cy, 18, 0, Math.PI*2);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(cx-28, cy);
    ctx.lineTo(cx-8, cy);
    ctx.moveTo(cx+8, cy);
    ctx.lineTo(cx+28, cy);
    ctx.moveTo(cx, cy-28);
    ctx.lineTo(cx, cy-8);
    ctx.moveTo(cx, cy+8);
    ctx.lineTo(cx, cy+28);
    ctx.stroke();
  }

  function sampleCenterPixel(){
    const tmp = document.createElement("canvas");
    tmp.width = video.videoWidth;
    tmp.height = video.videoHeight;

    const tctx = tmp.getContext("2d");
    tctx.drawImage(video,0,0,tmp.width,tmp.height);

    const cx = Math.floor(tmp.width/2);
    const cy = Math.floor(tmp.height/2);

    try{
      const d = tctx.getImageData(cx,cy,1,1).data;
      return {r:d[0], g:d[1], b:d[2]};
    }catch(e){
      return {r:0,g:0,b:0};
    }
  }

  function updateColorUI({r,g,b}){
    const hex = rgbToHex(r,g,b);
    const hsl = rgbToHslArray(r,g,b);
    const name = lookupBasicColorName(r,g,b);

    swatch.style.background = hex;
    colorNameEl.textContent = name;

    rgbText.textContent = `RGB: ${r}, ${g}, ${b}`;
    hexText.textContent = `HEX: ${hex}`;
    hslText.textContent = `HSL: ${Math.round(hsl[0])}¬∞, ${Math.round(hsl[1])}%, ${Math.round(hsl[2])}%`;

    detectedNameEl.textContent = name;
  }

  function lookupBasicColorName(r, g, b){
    let brightness = (r+g+b)/3;
    let diff = Math.max(r,g,b) - Math.min(r,g,b);

    if(brightness > 200 && diff < 20) return "Putih";
    if(brightness < 50 && diff < 20) return "Hitam";
    if(diff < 20) return "Abu-abu";

    if(r>180 && g<100 && b<100) return "Merah";
    if(g>170 && r<120 && b<120) return "Hijau";
    if(b>150 && r<120 && g<120) return "Biru";
    if(r>200 && g>200 && b<120) return "Kuning";
    if(r>150 && b>150 && g<130) return "Ungu / Magenta";
    if(g>150 && b>150 && r<130) return "Cyan";

    if(r>120 && g>90 && b<70) return "Coklat";
    if(r>160 && g>110 && b>90) return "Skin Tone";

    return "Tidak Dikenal";
  }

  function rgbToHex(r,g,b){
    return "#" + [r,g,b].map(v=>v.toString(16).padStart(2,"0")).join("").toUpperCase();
  }

  function rgbToHslArray(r,g,b){
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h,s,l=(max+min)/2;

    if(max===min){
      h=s=0;
    }else{
      const d=max-min;
      s = l>0.5 ? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h=(g-b)/d + (g<b?6:0); break;
        case g: h=(b-r)/d + 2; break;
        case b: h=(r-g)/d + 4; break;
      }
      h/=6;
    }

    return [h*360, s*100, l*100];
  }

  function estimateDistance(h){
    return Math.max(0.15, Math.min(10, DIST_CONST / h));
  }

  startBtn.addEventListener("click", startAll);
  stopBtn.addEventListener("click", stopAll);

  </script>

</body>
</html>
